<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>: Rack::Cache::MetaStore [Rack::Cache API Documentation]</title>
    <meta content='text/html; charset=utf8' http-equiv='Content-Type'>
    <link href='../../../rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>Class</span>
          Rack::Cache::MetaStore
        </h1>
        <ol class='paths'>
          <li>
            <a href="../../../files/lib/rack/cache/metastore_rb.html">lib/rack/cache/metastore.rb</a>
          </li>
        </ol>
        <div class='parent'>
          Parent:
          <strong>Object</strong>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            <p>
            The <a href="MetaStore.html">MetaStore</a> is responsible for storing meta
            information about a request/response pair keyed by the request&#8217;s URL.
            </p>
            <p>
            The meta store keeps a list of request/response pairs for each canonical
            request URL. A request/response pair is a two element Array of the form:
            </p>
            <pre>[request, response]</pre>
            <p>
            The <tt>request</tt> element is a Hash of <a
            href="../../Rack.html">Rack</a> environment keys. Only protocol keys (i.e.,
            those that start with &#8220;HTTP_&#8221;) are stored. The
            <tt>response</tt> element is a Hash of cached HTTP response headers for the
            paired request.
            </p>
            <p>
            The <a href="MetaStore.html">MetaStore</a> class is abstract and should not
            be instanstiated directly. Concrete subclasses should implement the
            protected <a href="MetaStore.html#M000075">read</a>, <a
            href="MetaStore.html#M000076">write</a>, and <a
            href="MetaStore.html#M000077">purge</a> methods. Care has been taken to
            keep these low-level methods dumb and straight-forward to implement.
            </p>
          </div>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public instance</h3>
            <ol>
              <li><a href="#M000073">cache_key</a></li>
              <li><a href="#M000074">invalidate</a></li>
              <li><a href="#M000071">lookup</a></li>
              <li><a href="#M000072">store</a></li>
            </ol>
            <h3>protected instance</h3>
            <ol>
              <li><a href="#M000077">purge</a></li>
              <li><a href="#M000075">read</a></li>
              <li><a href="#M000076">write</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='class-list'>
              <h2>Classes and Modules</h2>
              Class <a href="MetaStore/Disk.html" class="link">Rack::Cache::MetaStore::Disk</a><br />
              Class <a href="MetaStore/Heap.html" class="link">Rack::Cache::MetaStore::Heap</a><br />
              Class <a href="MetaStore/MemCache.html" class="link">Rack::Cache::MetaStore::MemCache</a><br />
              Class <a href="MetaStore/MemCacheBase.html" class="link">Rack::Cache::MetaStore::MemCacheBase</a><br />
              Class <a href="MetaStore/MemCached.html" class="link">Rack::Cache::MetaStore::MemCached</a><br />
            </div>
            <div id='constants-list'>
              <h2>Constants</h2>
              <div class='name-list'>
                <table summary='Constants'>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>HEAP</td>
                    <td>=</td>
                    <td class='context-item-value'>Heap</td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>MEM</td>
                    <td>=</td>
                    <td class='context-item-value'>HEAP</td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>DISK</td>
                    <td>=</td>
                    <td class='context-item-value'>Disk</td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>FILE</td>
                    <td>=</td>
                    <td class='context-item-value'>Disk</td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>MEMCACHE</td>
                    <td>=</td>
                    <td class='context-item-value'>if defined?(::Memcached)</td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='methods'>
              <h2>Public instance methods</h2>
              <div class='method public-instance' id='method-M000073'>
                <a name='M000073'></a>
                <div class='synopsis'>
                  <span class='name'>cache_key</span>
                  <span class='arguments'>(request)</span>
                </div>
                <div class='description'>
                  <p>
                  Generate a cache key for the request.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000073-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000073-source'>    <span class="ruby-comment cmt"># File lib/rack/cache/metastore.rb, line 83</span>&#x000A;83:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cache_key</span>(<span class="ruby-identifier">request</span>)&#x000A;84:       <span class="ruby-identifier">keygen</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-value str">'rack-cache.cache_key'</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Key</span>&#x000A;85:       <span class="ruby-identifier">keygen</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">request</span>)&#x000A;86:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000074'>
                <a name='M000074'></a>
                <div class='synopsis'>
                  <span class='name'>invalidate</span>
                  <span class='arguments'>(request, entity_store)</span>
                </div>
                <div class='description'>
                  <p>
                  Invalidate all cache entries that match the request.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000074-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000074-source'>     <span class="ruby-comment cmt"># File lib/rack/cache/metastore.rb, line 89</span>&#x000A; 89:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">invalidate</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">entity_store</span>)&#x000A; 90:       <span class="ruby-identifier">modified</span> = <span class="ruby-keyword kw">false</span>&#x000A; 91:       <span class="ruby-identifier">key</span> = <span class="ruby-identifier">cache_key</span>(<span class="ruby-identifier">request</span>)&#x000A; 92:       <span class="ruby-identifier">entries</span> =&#x000A; 93:         <span class="ruby-identifier">read</span>(<span class="ruby-identifier">key</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span><span class="ruby-operator">|</span>&#x000A; 94:           <span class="ruby-identifier">response</span> = <span class="ruby-identifier">restore_response</span>(<span class="ruby-identifier">res</span>)&#x000A; 95:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">fresh?</span>&#x000A; 96:             <span class="ruby-identifier">response</span>.<span class="ruby-identifier">expire!</span>&#x000A; 97:             <span class="ruby-identifier">modified</span> = <span class="ruby-keyword kw">true</span>&#x000A; 98:             [<span class="ruby-identifier">req</span>, <span class="ruby-identifier">persist_response</span>(<span class="ruby-identifier">response</span>)]&#x000A; 99:           <span class="ruby-keyword kw">else</span>&#x000A;100:             [<span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>]&#x000A;101:           <span class="ruby-keyword kw">end</span>&#x000A;102:         <span class="ruby-keyword kw">end</span>&#x000A;103:       <span class="ruby-identifier">write</span> <span class="ruby-identifier">key</span>, <span class="ruby-identifier">entries</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">modified</span>&#x000A;104:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000071'>
                <a name='M000071'></a>
                <div class='synopsis'>
                  <span class='name'>lookup</span>
                  <span class='arguments'>(request, entity_store)</span>
                </div>
                <div class='description'>
                  <p>
                  Locate a cached response for the request provided. Returns a <a
                  href="Response.html">Rack::Cache::Response</a> object if the cache hits or
                  nil if no cache entry was found.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000071-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000071-source'>    <span class="ruby-comment cmt"># File lib/rack/cache/metastore.rb, line 27</span>&#x000A;27:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">lookup</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">entity_store</span>)&#x000A;28:       <span class="ruby-identifier">key</span> = <span class="ruby-identifier">cache_key</span>(<span class="ruby-identifier">request</span>)&#x000A;29:       <span class="ruby-identifier">entries</span> = <span class="ruby-identifier">read</span>(<span class="ruby-identifier">key</span>)&#x000A;30: &#x000A;31:       <span class="ruby-comment cmt"># bail out if we have nothing cached</span>&#x000A;32:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">entries</span>.<span class="ruby-identifier">empty?</span>&#x000A;33: &#x000A;34:       <span class="ruby-comment cmt"># find a cached entry that matches the request.</span>&#x000A;35:       <span class="ruby-identifier">env</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>&#x000A;36:       <span class="ruby-identifier">match</span> = <span class="ruby-identifier">entries</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">req</span>,<span class="ruby-identifier">res</span><span class="ruby-operator">|</span> <span class="ruby-identifier">requests_match?</span>(<span class="ruby-identifier">res</span>[<span class="ruby-value str">'Vary'</span>], <span class="ruby-identifier">env</span>, <span class="ruby-identifier">req</span>)}&#x000A;37:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">match</span>.<span class="ruby-identifier">nil?</span>&#x000A;38: &#x000A;39:       <span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span> = <span class="ruby-identifier">match</span>&#x000A;40:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span> = <span class="ruby-identifier">entity_store</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">res</span>[<span class="ruby-value str">'X-Content-Digest'</span>])&#x000A;41:         <span class="ruby-identifier">restore_response</span>(<span class="ruby-identifier">res</span>, <span class="ruby-identifier">body</span>)&#x000A;42:       <span class="ruby-keyword kw">else</span>&#x000A;43:         <span class="ruby-comment cmt"># TODO the metastore referenced an entity that doesn't exist in</span>&#x000A;44:         <span class="ruby-comment cmt"># the entitystore. we definitely want to return nil but we should</span>&#x000A;45:         <span class="ruby-comment cmt"># also purge the entry from the meta-store when this is detected.</span>&#x000A;46:       <span class="ruby-keyword kw">end</span>&#x000A;47:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000072'>
                <a name='M000072'></a>
                <div class='synopsis'>
                  <span class='name'>store</span>
                  <span class='arguments'>(request, response, entity_store)</span>
                </div>
                <div class='description'>
                  <p>
                  Write a cache entry to the store under the given key. Existing entries are
                  read and any that match the response are removed. This method calls <a
                  href="MetaStore.html#M000076">write</a> with the new list of cache entries.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000072-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000072-source'>    <span class="ruby-comment cmt"># File lib/rack/cache/metastore.rb, line 52</span>&#x000A;52:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">store</span>(<span class="ruby-identifier">request</span>, <span class="ruby-identifier">response</span>, <span class="ruby-identifier">entity_store</span>)&#x000A;53:       <span class="ruby-identifier">key</span> = <span class="ruby-identifier">cache_key</span>(<span class="ruby-identifier">request</span>)&#x000A;54:       <span class="ruby-identifier">stored_env</span> = <span class="ruby-identifier">persist_request</span>(<span class="ruby-identifier">request</span>)&#x000A;55: &#x000A;56:       <span class="ruby-comment cmt"># write the response body to the entity store if this is the</span>&#x000A;57:       <span class="ruby-comment cmt"># original response.</span>&#x000A;58:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'X-Content-Digest'</span>].<span class="ruby-identifier">nil?</span>&#x000A;59:         <span class="ruby-identifier">digest</span>, <span class="ruby-identifier">size</span> = <span class="ruby-identifier">entity_store</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span>)&#x000A;60:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'X-Content-Digest'</span>] = <span class="ruby-identifier">digest</span>&#x000A;61:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Content-Length'</span>] = <span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">'Transfer-Encoding'</span>]&#x000A;62:         <span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">entity_store</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">digest</span>)&#x000A;63:       <span class="ruby-keyword kw">end</span>&#x000A;64: &#x000A;65:       <span class="ruby-comment cmt"># read existing cache entries, remove non-varying, and add this one to</span>&#x000A;66:       <span class="ruby-comment cmt"># the list</span>&#x000A;67:       <span class="ruby-identifier">vary</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">vary</span>&#x000A;68:       <span class="ruby-identifier">entries</span> =&#x000A;69:         <span class="ruby-identifier">read</span>(<span class="ruby-identifier">key</span>).<span class="ruby-identifier">reject</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">env</span>,<span class="ruby-identifier">res</span><span class="ruby-operator">|</span>&#x000A;70:           (<span class="ruby-identifier">vary</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">res</span>[<span class="ruby-value str">'Vary'</span>]) <span class="ruby-operator">&amp;&amp;</span>&#x000A;71:             <span class="ruby-identifier">requests_match?</span>(<span class="ruby-identifier">vary</span>, <span class="ruby-identifier">env</span>, <span class="ruby-identifier">stored_env</span>)&#x000A;72:         <span class="ruby-keyword kw">end</span>&#x000A;73: &#x000A;74:       <span class="ruby-identifier">headers</span> = <span class="ruby-identifier">persist_response</span>(<span class="ruby-identifier">response</span>)&#x000A;75:       <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">delete</span> <span class="ruby-value str">'Age'</span>&#x000A;76: &#x000A;77:       <span class="ruby-identifier">entries</span>.<span class="ruby-identifier">unshift</span> [<span class="ruby-identifier">stored_env</span>, <span class="ruby-identifier">headers</span>]&#x000A;78:       <span class="ruby-identifier">write</span> <span class="ruby-identifier">key</span>, <span class="ruby-identifier">entries</span>&#x000A;79:       <span class="ruby-identifier">key</span>&#x000A;80:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Protected instance methods</h2>
              <div class='method protected-instance' id='method-M000077'>
                <a name='M000077'></a>
                <div class='synopsis'>
                  <span class='name'>purge</span>
                  <span class='arguments'>(key)</span>
                </div>
                <div class='description'>
                  <p>
                  Remove all cached entries at the key specified. No error is raised when the
                  key does not exist.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000077-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000077-source'>     <span class="ruby-comment cmt"># File lib/rack/cache/metastore.rb, line 158</span>&#x000A;158:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">purge</span>(<span class="ruby-identifier">key</span>)&#x000A;159:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">NotImplemented</span>&#x000A;160:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method protected-instance' id='method-M000075'>
                <a name='M000075'></a>
                <div class='synopsis'>
                  <span class='name'>read</span>
                  <span class='arguments'>(key)</span>
                </div>
                <div class='description'>
                  <p>
                  Locate all cached request/response pairs that match the specified URL key.
                  The result must be an Array of all cached request/response pairs. An empty
                  Array must be returned if nothing is cached for the specified key.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000075-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000075-source'>     <span class="ruby-comment cmt"># File lib/rack/cache/metastore.rb, line 145</span>&#x000A;145:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read</span>(<span class="ruby-identifier">key</span>)&#x000A;146:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">NotImplemented</span>&#x000A;147:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method protected-instance' id='method-M000076'>
                <a name='M000076'></a>
                <div class='synopsis'>
                  <span class='name'>write</span>
                  <span class='arguments'>(key, negotiations)</span>
                </div>
                <div class='description'>
                  <p>
                  Store an Array of request/response pairs for the given key. Concrete
                  implementations should not attempt to filter or concatenate the list in any
                  way.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000076-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000076-source'>     <span class="ruby-comment cmt"># File lib/rack/cache/metastore.rb, line 152</span>&#x000A;152:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">write</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">negotiations</span>)&#x000A;153:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">NotImplemented</span>&#x000A;154:     <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
